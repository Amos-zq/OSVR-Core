#
# Builds project on Appveyor <http://www.appveyor.com/>
#

platform:
  - x86
  - x64

configuration:
  - Debug
  - Release
  - RelWithDebInfo

environment:
  matrix:
    - GENERATOR: Visual Studio 12
      GEN: vc12
      BOOST_ROOT: C:\Libraries\boost_1_58_0
    - GENERATOR: Visual Studio 14
      GEN: vc14
      BOOST_ROOT: C:\Libraries\boost_1_60_0

install:
  - if "%PLATFORM%"=="x86" (set BOOST_ARCH=lib32) else (set BOOST_ARCH=lib64)
  - if "%GEN%"=="vc12" (set BOOST_COMPILER=msvc-12.0) else (set BOOST_COMPILER=msvc-14.0)
  - set BOOST_LIBRARYDIR=%BOOST_ROOT%\%BOOST_ARCH%-%BOOST_COMPILER%
  - set PATH=%PATH%;%BOOST_ROOT%
  - ps: choco source add --name="osvr-deps" -s="https://www.myget.org/F/osvr-deps/"
  - ps: choco install -y OpenCV -version 2.4.13
  - ps: choco pin add -name OpenCV
  - set OPENCV_DIR=c:\tools\opencv\build\%PLATFORM%\%GEN%
  - set PATH=%PATH%;%OPENCV_DIR%\bin
  - if "%PLATFORM%"=="x64" (set GENERATOR=%GENERATOR% Win64)
  - set

# TODO set up cache for dependencies

# build dependencies
before_build:
  - cd ..

  - git clone --recursive https://github.com/open-source-parsers/jsoncpp.git
  - cd jsoncpp
  - mkdir build
  - cd build
  - cmake .. -G "%GENERATOR%" -DCMAKE_INSTALL_PREFIX=c:\osvr -DBUILD_STATIC_LIBS=ON -DBUILD_SHARED_LIBS=OFF -DJSONCPP_WITH_CMAKE_PACKAGE=ON
  - cmake --build . --config "%CONFIGURATION%" --target install
  - cd ..
  - cd ..

  - git clone --recursive https://github.com/OSVR/libfunctionality.git
  - cd libfunctionality
  - mkdir build
  - cd build
  - cmake .. -G "%GENERATOR%" -DCMAKE_INSTALL_PREFIX=c:\osvr
  - cmake --build . --config "%CONFIGURATION%" --target install
  - cd ..
  - cd ..

  - cd osvr-core


build:
  parallel: true

build_script:
  - git submodule update --init --recursive
  - mkdir build
  - cd build
  - cmake .. -G "%GENERATOR%" -DCMAKE_INSTALL_PREFIX="c:\osvr" -DCMAKE_PREFIX_PATH="c:\osvr" -DBUILD_HEADER_DEPENDENCY_TESTS=1  -DBUILD_CLIENT_APPS=1 -DBUILD_CLIENT_EXAMPLES=1  -DBUILD_SERVER_APP=1 -DBUILD_SERVER_EXAMPLES=1 -DBUILD_SERVER_PLUGINS=1 -DBUILD_TESTING=1 -DBoost_DEBUG=1 -DBoost_DETAILED_FAILURE_MSG=1 -DOpenCV_DIR=%OPENCV_DIR%\lib
  - cmake --build . --config "%CONFIGURATION%"

